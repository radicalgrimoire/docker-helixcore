name: test

env:
  # P4 Configuration - non-sensitive settings
  P4ROOT: /opt/perforce/servers/master
  P4NAME: master
  P4PORT: ssl:1666
  P4HOME: /opt/perforce/servers
  CASE_INSENSITIVE: 0

on:
  workflow_call:
    inputs:
      docker_files_name:
        required: true
        type: string


jobs:

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
            docker build \
             -t ${{ secrets.IMAGE_NAME }} \
             --build-arg P4NAME=${{ env.P4NAME }} \
             --build-arg P4PORT=${{ env.P4PORT }} \
             --build-arg P4USER=${{ secrets.P4USER }} \
             --build-arg P4PASSWD=${{ secrets.P4PASSWD }} \
             --build-arg P4HOME=${{ env.P4HOME }} \
             --build-arg P4ROOT=${{ env.P4ROOT }} \
             --build-arg CASE_INSENSITIVE=${{ env.CASE_INSENSITIVE }} \
             -f ./build/${{ inputs.docker_files_name }} ./build

      - name: Run tests
        run: |
            # テスト処理をここに追加
            echo "Testing image: ${{ secrets.IMAGE_NAME }}"
            docker run --rm ${{ secrets.IMAGE_NAME }} p4d -h || true

      - name: Save Docker image as artifact
        run: |
            docker save ${{ secrets.IMAGE_NAME }} > ${{ secrets.IMAGE_NAME }}.tar
            
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ secrets.IMAGE_NAME }}
          path: ${{ secrets.IMAGE_NAME }}.tar
          retention-days: 1