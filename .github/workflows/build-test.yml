name: build-test

run-name: >
  Build Test: ${{ inputs.dockerfile || 'Dockerfile' }} 
  (${{ github.event_name }})
  by @${{ github.actor }}

on:
  push:
    paths:
      - 'build/**'
      - '.github/workflows/build-test.yml'
  
  workflow_dispatch:
    inputs:
      dockerfile:
        description: 'Dockerfile to use for building'
        required: false
        default: 'Dockerfile'
        type: string


jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Display test information
        run: |
          echo "=== Build Test Information ==="
          echo "Event: ${{ github.event_name }}"
          echo "Dockerfile: ${{ inputs.dockerfile || 'Dockerfile' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""

      - name: Build image
        run: |
          DOCKERFILE_NAME="${{ inputs.dockerfile || 'Dockerfile' }}"
          echo "Building Docker image with $DOCKERFILE_NAME..."
          # secrets.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä»˜ãï¼‰
          echo "P4USER=${{ secrets.P4USER || 'defaultuser' }}" > build/secrets.env
          echo "P4PASSWD=${{ secrets.P4PASSWD || 'defaultpass' }}" >> build/secrets.env
          echo "IMAGE_NAME=${{ secrets.IMAGE_NAME || 'helix-p4d-test' }}" >> build/secrets.env
          bash ./build/docker-build.sh "$DOCKERFILE_NAME" ./build

      - name: Test basic functionality
        run: |
          echo "=== Testing basic functionality ==="
          echo "Testing p4d help command..."
          docker run --rm ${{ secrets.IMAGE_NAME }} p4d -h || true
          
          echo ""
          echo "Getting P4D version..."
          docker run --rm ${{ secrets.IMAGE_NAME }} p4d -V || true
          
          echo ""
          echo "Checking installed packages..."
          docker run --rm ${{ secrets.IMAGE_NAME }} dpkg -l | grep -E "(helix|perforce)" || true

      - name: Check image size
        run: |
          echo "=== Docker Image Size Information ==="
          docker images ${{ secrets.IMAGE_NAME }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          echo ""
          
          # è©³ç´°ã‚µã‚¤ã‚ºæƒ…å ±
          IMAGE_SIZE=$(docker images ${{ secrets.IMAGE_NAME }} --format "{{.Size}}")
          echo "ğŸ“Š Image Size: $IMAGE_SIZE"
          
          # åœ§ç¸®ã‚µã‚¤ã‚ºï¼ˆå®Ÿéš›ã®è»¢é€ã‚µã‚¤ã‚ºã«è¿‘ã„ï¼‰
          echo "ğŸ“¦ Calculating compressed size..."
          docker save ${{ secrets.IMAGE_NAME }} | gzip | wc -c | awk '{printf "Compressed size: %.2f MB\n", $1/1024/1024}'
          
          # ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
          echo ""
          echo "ğŸ” Image layers:"
          docker history ${{ secrets.IMAGE_NAME }} --format "table {{.Size}}\t{{.CreatedBy}}" | head -10

      - name: Test summary
        run: |
          echo "=== Build Test Completed Successfully ==="
          echo "Docker image built successfully"
          echo "âœ… Basic functionality tests passed"
          echo "ğŸ“‹ Dockerfile used: ${{ inputs.dockerfile || 'Dockerfile' }}"
          
          # æœ€çµ‚ã‚µã‚¤ã‚ºæƒ…å ±ã‚’ã‚µãƒãƒªãƒ¼ã«è¡¨ç¤º
          IMAGE_SIZE=$(docker images ${{ secrets.IMAGE_NAME }} --format "{{.Size}}")
          echo "ğŸ“Š Final image size: $IMAGE_SIZE"
          
          echo ""
          echo "Note: This is a build test only. No images were saved or published."