name: publish

env:
  TAG_LATEST: latest
  TAG_NIGHTLY: nightly

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      version_raw:
        required: true
        type: string


jobs:
  # Push image to GitHub Packages.
  # See also https://docs.docker.com/docker-hub/builds/
  # TAG_SUFFIX="nightly-$(date +'%Y%m%d')"
  publish:
    # Ensure test job passes before pushing image.
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ secrets.IMAGE_NAME }}

      - name: Load Docker image
        run: |
            docker load < ${{ secrets.IMAGE_NAME }}.tar
            echo "Loaded Docker image: ${{ secrets.IMAGE_NAME }}"
            docker images | grep ${{ secrets.IMAGE_NAME }}

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set current datetime as env variable
        env:
          TZ: 'Asia/Tokyo'
        run: echo "CURRENT_DATETIME=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Push image
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository }}/${{ secrets.IMAGE_NAME }}
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          VERSION="${{ inputs.version }}"
          echo "P4Dバージョン（タグ用）: $VERSION"
          
          # P4Dバージョン + ビルド番号タグ
          docker tag ${{ secrets.IMAGE_NAME }} $IMAGE_ID:$VERSION.$GITHUB_RUN_NUMBER
          docker push $IMAGE_ID:$VERSION.$GITHUB_RUN_NUMBER

          # 最新タグ
          docker tag ${{ secrets.IMAGE_NAME }} $IMAGE_ID:${{ env.TAG_LATEST }}
          docker push $IMAGE_ID:${{ env.TAG_LATEST }}

          # ナイトリータグ（スケジュール実行時のみ）
          if [ "${{ github.event_name }}" == "schedule" ]; then
            docker tag ${{ secrets.IMAGE_NAME }} $IMAGE_ID:${{ env.TAG_NIGHTLY }}
            docker push $IMAGE_ID:${{ env.TAG_NIGHTLY }}
          fi
          