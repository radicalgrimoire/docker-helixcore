name: build-develop

run-name: >
  ${{ github.event_name == 'schedule' && 'Scheduled Build' || 'Manual Build' }}
  ${{ inputs.dockerfile || 'Dockerfile' }}  
  by @${{ github.actor }}

on:
  schedule:
    # JST 朝9時 = UTC 0時（JST = UTC + 9時間）
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    inputs:
      dockerfile:
        description: 'Dockerfile to use for building'
        required: false
        default: 'Dockerfile'
        type: choice
        options:
          - 'Dockerfile'
          - 'Dockerfile.v2'
 
jobs:
  # Display commit information
  info:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Display build information
        run: |
          echo "Build Information:"
          echo "Event: ${{ github.event_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          # Get last commit author and message
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" HEAD)
          echo "Auther: ${COMMIT_AUTHOR} / ${COMMIT_MESSAGE}"

  # Check if today is the designated day to push (Monday) or if manually triggered.
  # Uses external reusable workflow for day checking logic
  check-day:
    needs: info
    uses: radicalgrimoire/github-actions-utils/.github/workflows/check-schedule-day.yml@main
    with:
      schedule_type: 'weekly'
      target_value: '1'      # Monday
      timezone: 'Asia/Tokyo'

  # Run tests.
  # See also https://docs.docker.com/docker-hub/builds/automated-testing/
  # if: github.event_name == 'push' || github.event_name == 'pull_request'
  test:
    needs: [info, check-day]
    uses: ./.github/workflows/test.yml
    with:
      # スケジュール実行時はDockerfile、手動実行時は選択されたファイルを使用
      docker_files_name: ${{ inputs.dockerfile || 'Dockerfile' }}
      should_push: ${{ needs.check-day.outputs.should-push }}
    secrets: inherit

  # P4Dバージョン取得ステップ
  get-version:
    needs: [check-day, test]
    if: needs.check-day.outputs.should-push == 'true'
    uses: ./.github/workflows/get-version.yml
    secrets: inherit

  # Push image to GitHub Packages.
  # See also https://docs.docker.com/docker-hub/builds/
  # TAG_SUFFIX="nightly-$(date +'%Y%m%d')"
  push:
    uses: ./.github/workflows/publish.yml
    needs: [check-day, get-version]
    if: needs.check-day.outputs.should-push == 'true'
    with:
      version: ${{ needs.get-version.outputs.version }}
      version_raw: ${{ needs.get-version.outputs.version_raw }}
    secrets: inherit
