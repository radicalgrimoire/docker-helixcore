name: build-develop

run-name: >
  ${{ github.event_name == 'schedule' && 'Scheduled Build' || 'Manual Build' }}
  ${{ inputs.dockerfile || 'Dockerfile' }}  
  by @${{ github.actor }}

on:
  schedule:
    # JST æœ9æ™‚ = UTC 0æ™‚ï¼ˆJST = UTC + 9æ™‚é–“ï¼‰
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    inputs:
      dockerfile:
        description: 'Dockerfile to use for building'
        required: false
        default: 'Dockerfile'
        type: string
 
jobs:
  # Display commit information
  info:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Display build information
        run: |
          echo "Build Information:"
          echo "Event: ${{ github.event_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          # Get last commit author and message
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" HEAD)
          echo "Auther: ${COMMIT_AUTHOR} / ${COMMIT_MESSAGE}"

  # Check if today is the designated day to push (Monday) or if manually triggered.
  # Uses external reusable workflow for day checking logic
  check-day:
    needs: info
    uses: radicalgrimoire/github-actions-utils/.github/workflows/check-schedule-day.yml@main
    with:
      schedule_type: 'weekly'
      target_value: '1'      # Monday
      timezone: 'Asia/Tokyo'

  # Run tests.
  # See also https://docs.docker.com/docker-hub/builds/automated-testing/
  # if: github.event_name == 'push' || github.event_name == 'pull_request'
  # secrets.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
  create-secrets:
    needs: [info, check-day]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create secrets.env file
        run: |
          # ç’°å¢ƒå¤‰æ•°çµŒç”±ã§ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œãªã„ï¼‰
          cat << EOF > build/secrets.env
          P4USER=${P4USER}
          P4PASSWD=${P4PASSWD}
          IMAGE_NAME=${IMAGE_NAME}
          EOF
          echo "secrets.env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ä½œæˆã—ã¾ã—ãŸ"
        env:
          P4USER: ${{ secrets.P4USER || 'defaultuser' }}
          P4PASSWD: ${{ secrets.P4PASSWD || 'defaultpass' }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME || 'helix-p4d-test' }}
      - name: Upload secrets.env as artifact
        uses: actions/upload-artifact@v4
        with:
          name: secrets-env
          path: build/secrets.env
          retention-days: 1

  test:
    needs: [info, check-day, create-secrets]
    uses: ./.github/workflows/test.yml
    with:
      # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã¯Dockerfileã€æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
      docker_files_name: ${{ inputs.dockerfile || 'Dockerfile' }}
      should_push: ${{ needs.check-day.outputs.should-push }}
    secrets: inherit

  # P4Dãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—ã‚¹ãƒ†ãƒƒãƒ—
  get-version:
    needs: [check-day, test]
    if: needs.check-day.outputs.should-push == 'true'
    uses: ./.github/workflows/get-version.yml
    secrets: inherit

  # Push image to GitHub Packages.
  # See also https://docs.docker.com/docker-hub/builds/
  # TAG_SUFFIX="nightly-$(date +'%Y%m%d')"
  push:
    uses: ./.github/workflows/publish.yml
    needs: [check-day, get-version]
    if: needs.check-day.outputs.should-push == 'true'
    with:
      version: ${{ needs.get-version.outputs.version }}
      version_raw: ${{ needs.get-version.outputs.version_raw }}
    secrets: inherit

  # Create issue on failure
  create-failure-issue:
    runs-on: ubuntu-latest
    if: always() && (needs.test.result == 'failure' || needs.get-version.result == 'failure' || needs.push.result == 'failure')
    needs: [info, check-day, test, get-version, push]
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const failedJobs = [];
            const needs = ${{ toJSON(needs) }};
            
            // å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã‚’ç‰¹å®š
            if (needs.test?.result === 'failure') failedJobs.push('test');
            if (needs['get-version']?.result === 'failure') failedJobs.push('get-version');  
            if (needs.push?.result === 'failure') failedJobs.push('push');
            
            const triggerType = '${{ github.event_name }}' === 'schedule' ? 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ' : 'æ‰‹å‹•å®Ÿè¡Œ';
            const dockerfile = '${{ inputs.dockerfile || 'Dockerfile' }}';
            const currentDate = new Date().toLocaleDateString('ja-JP');
            const currentDateTime = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
            
            // issueã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ä½œæˆ
            const title = 'ğŸš¨ Build Failed: ' + triggerType + ' (' + currentDate + ')';
            const failedJobsList = failedJobs.map(job => '- `' + job + '`').join('\n');
            
            // æœ¬æ–‡ã‚’æ®µéšçš„ã«ä½œæˆ
            let body = '## ãƒ“ãƒ«ãƒ‰å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ\n\n';
            body += '**å®Ÿè¡Œæƒ…å ±:**\n';
            body += '- ãƒˆãƒªã‚¬ãƒ¼: ' + triggerType + '\n';
            body += '- Dockerfile: `' + dockerfile + '`\n';
            body += '- ãƒ–ãƒ©ãƒ³ãƒ: `${{ github.ref_name }}`\n';
            body += '- ã‚³ãƒŸãƒƒãƒˆ: `${{ github.sha }}`\n';
            body += '- å®Ÿè¡Œè€…: @${{ github.actor }}\n';
            body += '- å®Ÿè¡Œæ™‚åˆ»: ' + currentDateTime + ' JST\n\n';
            body += '**å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–:**\n';
            body += failedJobsList + '\n\n';
            body += '**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ:**\n';
            body += '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n';
            body += '**å¯¾å¿œãŒå¿…è¦ãªé …ç›®:**\n';
            body += '- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª\n';
            body += '- [ ] å¤±æ•—åŸå› ã®ç‰¹å®š\n';
            body += '- [ ] ä¿®æ­£ä½œæ¥­\n';
            body += '- [ ] å‹•ä½œç¢ºèª\n\n';
            body += '_ã“ã®issueã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£å®Œäº†å¾Œã¯closeã—ã¦ãã ã•ã„ã€‚_';

            try {
              const issue = await github.rest.issues.create({
                owner: 'radicalgrimoire',
                repo: 'docker-helixcore',
                title: title,
                body: body,
                labels: ['bug', 'build-failure', 'auto-created'],
                assignees: ['radicalgrimoire']
              });
              
              console.log('Issue created: ' + issue.data.html_url);
            } catch (error) {
              console.error('Failed to create issue:', error);
              // issueã®ä½œæˆã«å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã¯å¤±æ•—ã•ã›ãªã„
            }
